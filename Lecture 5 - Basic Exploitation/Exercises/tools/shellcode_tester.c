#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>
#include <sys/mman.h>


#define BUFSIZE 0x1000
#define USAGE ("Usage: shellcode_tester # [filename]\n"\
			   "\t# = 0 if shellcode is ARM code\n"\
			   "\t# = 1 if shellcode is thumb code\n"\
			   "\tIf filename is not specified, "\
			   "receives shellcode from stdio using 'gets' function\n"\
			   "Max shellcode size 0x1000 bytes.\n")
#define INVALID ("Invalid first argument. Expected 0 or 1\n")
#define NOFILE ("No such file %s\n")
#define NOMMAP ("Could not allocate memory for shellcode\n")






int main(int argc, char **argv)
{

	FILE *fptr;
	char * filename;
	char buffer[BUFSIZE] __attribute__ ((aligned (4)));
	void *shellcode_data = MAP_FAILED;
	void (*shellcode_func)();
	char mode;
	int thumb;

	if (argc <= 1) {
		printf(USAGE);
		return(0);		
		}
	
	mode = argv[1][0];
	if ((strlen(argv[1])>1) || ((mode != '0') && (mode != '1'))) {
		printf(INVALID);
		return (1);
		}
	thumb = mode - '0';
	
	if (argc <= 2)
		gets(buffer);
	else {
		filename = argv[2];
		fptr = fopen(filename, "rb");
		if (fptr == NULL) {
			printf(NOFILE, filename);
			return(1);
			}
		else {
			fread(buffer, sizeof(char), BUFSIZE, fptr);
			fclose(fptr);
			}
		}

	shellcode_data = mmap(0, BUFSIZE, 
		PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_ANON, 0, 0);
	
	if (shellcode_data == MAP_FAILED) {
		printf(NOMMAP, filename);
		return(1);		
		}

	memcpy(shellcode_data, buffer, BUFSIZE);
	
	shellcode_func = (void (*)()) (shellcode_data + thumb);
	shellcode_func();	
	
}

